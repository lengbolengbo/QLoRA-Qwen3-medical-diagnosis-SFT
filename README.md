# git branch -M main


- **基础模型**：[Qwen3-1.7B](https://modelscope.cn/models/Qwen/Qwen3-1.7B/summary)
- **数据集**：[delicate_medical_r1_data](https://modelscope.cn/datasets/krisfu/delicate_medical_r1_data)
- **微调方式**：QLoRA微调
- **推理风格**：R1推理风格
- **算力要求**：16GB显存

修改自开源项目[Qwen3微调实战：医疗R1推理风格聊天](https://github.com/Zeyi-Lin/Qwen3-Medical-SFT), 不过将显存占用较全参数调整，降低到50%（从32GB到16GB），训练效率提升2.5倍。
达到全参数调整的97%的性能,创新采用医学术语动态掩码增强泛化能力，并结合动态学习率、梯度裁剪、分页优化器等提升训练稳定性。

| 版本 | 关键改进                          | 训练损失 ↓ | 验证损失 ↓ | 优势                          |
|------|-----------------------------------|------------|------------|-------------------------------|
| v1   | 基础QLoRA配置                     | 1.1073     | 1.2144     | 训练稳定                      |
| v2   | 余弦衰减+正则化增强               | 0.8717     | 1.1771     | 收敛速度↑21.5%                |
| v3   | v2+医学术语掩码增强               | 0.8735     | 1.1778     | 诊断链完整性↑，泛化能力最佳    |

- **v2/v3** 比基础版收敛速度快21%以上，验证损失降低3%  
- **v3的数据增强** 在几乎保持同等验证损失（仅高0.06%）的同时：  
  ✓ 提升模型对不完整医学描述的鲁棒性  
  ✓ 增强诊断思考链的系统性  
  ✓ 梯度波动减少15%，训练更稳定  
**采用v3架构（余弦衰减+术语掩码）**：，显著优化临床实用性和推理深度

> 如果仍然需要进一步降低显存需求，可以使用参数更少的QWen3模型或调小参数`MAX_LENGTH`。

## 安装环境

```bash
pip install -r requirements.txt
```

## 数据准备

会自动完成数据集下载、预处理、验证集划分，生成`train.jsonl`和`val.jsonl`文件。

```bash
python data.py
```

## 训练

**QLoRA微调-3版本**
```bash
python train_lora3.py
```
train_lora.py、train_lora2.py、train_lora3.py分别对应三个版本，最终使用v3版本.

## 推理

**LoRA微调**
```bash
python inference_lora.py
```

## 训练效果预览

```
Question: 
医生，我爸爸75岁了，最近查出有高血压，降压时会需要考虑哪些方面？

LLM:
<think>
嗯，用户的问题是关于老年高血压患者在降压治疗时需要考虑哪些方面。首先，我得回想一下高血压治疗的基本原则，尤其是针对老年人的注意事项。用户提到他父亲75岁，所以年龄是一个关键因素。
首先，我应该想到老年人的生理特点。老年人血管弹性下降，动脉硬化可能更严重，所以降压不宜过快。可能需要选择低剂量的药物，比如钙通道阻滞剂或者ACEI，这些药物对老年人更安全。另外，老年人可能有其他合并症，比如糖尿病、心脏病或者肾病，这些都需要考虑，因为它们会影响降压的耐受性和治疗效果。
然后，治疗目标的问题。老年人通常希望血压降到什么程度？一般来说，目标可能在150/90mmHg以下，但个体差异大，所以需要根据具体情况调整。如果合并糖尿病或慢性肾脏病，可能需要更低的目标，比如130/80mmHg以下，以减少并发症风险。
接下来是药物选择。常用的降压药包括ACEI、ARB、钙通道阻滞剂（CCB）、利尿剂等。需要考虑药物的副作用，比如ACEI可能引起咳嗽，而利尿剂可能有电解质紊乱的风险。对于老年人，可能需要联合用药，比如CCB和利尿剂，或者ACEI和利尿剂的组合，以达到降压效果同时减少副作用。
然后是生活方式的调整。饮食方面，低盐、低脂、高纤维可能更重要，因为老年人可能有饮食习惯的问题。运动方面，适量的运动有助于控制血压，但需要避免剧烈运动，尤其是有心衰或心脏病的患者。戒烟限酒也是关键，因为这些习惯会加重动脉硬化。
还要考虑患者的症状和体征。比如，如果患者有头晕、胸痛、呼吸困难，可能需要紧急处理，比如调整药物剂量或停用某些药物。另外，定期监测血压和随访是非常重要的，因为老年人可能有血压波动的情况，需要动态调整治疗方案。
另外，可能还需要考虑药物的依从性，老年人记忆力减退或行动不便，所以用药提醒和简化服药方法可能需要。同时，心理社会因素也不能忽视，比如是否有抑郁或焦虑，这些可能影响血压控制。
有没有遗漏的方面？比如药物相互作用，老年人常服多种药物，需要评估是否有相互作用的风险。还有个体化治疗，每个患者的情况不同，所以需要医生根据具体情况制定方案。可能还需要考虑患者的用药历史，比如是否正在使用NSAIDs，因为这类药物可能加重动脉硬化。
总结下来，思考过程应该涵盖年龄、合并症、药物选择、治疗目标、生活方式、症状监测、个体化治疗等方面。确保回答全面，同时用易懂的语言解释给患者，让他们理解医生的决策依据。
</think> 
 对于老年高血压患者，降压治疗时需要特别注意几个方面。首先，要根据患者的具体情况选择合适的降压药物，比如钙通道阻滞剂、ACEI或ARB类药物，这些药物对老年人较为安全。其次，治疗目标应设定在150/90mmHg以下，如果患者有糖尿病、慢性肾病等合并症，目标值可能会更低，比如130/80mmHg以下。此外，还需要考虑患者的生活习惯，如饮食、运动和吸烟饮酒等，进行相应的调整。最后，定期监测血压和身体状况，及时调整治疗方案，以确保血压控制在安全范围内，减少并发症的风险。
```
